<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiscoDuck Parquet Viewer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2rem; line-height: 1.5; }
        h1 { margin-bottom: 1rem; }
        .controls { margin-bottom: 1rem; padding: 1rem; background: #f6f8fa; border-radius: 6px; border: 1px solid #d0d7de; }
        select, input, button { font-size: 1rem; padding: 0.5rem; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        th, td { border: 1px solid #d0d7de; padding: 8px; text-align: left; }
        th { background-color: #f6f8fa; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        .error { color: #cf222e; font-weight: bold; margin-top: 1rem; }
        .loading { color: #0969da; font-weight: bold; }
        .pagination { margin-top: 1rem; display: flex; gap: 1rem; align-items: center; }
    </style>
</head>
<body>

<h1>DiscoDuck Data Viewer</h1>
<p>Viewing release: <code>2026-02</code></p>

<div class="controls">
    <label for="fileSelect"><strong>Select File:</strong></label><br>
    <select id="fileSelect">
        <option value="" disabled selected>Choose a parquet file...</option>
        <!-- Categories: Special -->
        <option value="_artists.parquet">_artists.parquet</option>
        <option value="_labels.parquet">_labels.parquet</option>
        <option value="_masters.parquet">_masters.parquet</option>
        <hr>
        <!-- Categories: Genres -->
        <option value="Blues-releases-basics.parquet">Blues - Basics</option>
        <option value="Blues-releases-tracks.parquet">Blues - Tracks</option>
        <option value="Blues-releases-videos.parquet">Blues - Videos</option>
        <option value="Brass_Military-releases-basics.parquet">Brass/Military - Basics</option>
        <option value="Brass_Military-releases-tracks.parquet">Brass/Military - Tracks</option>
        <option value="Brass_Military-releases-videos.parquet">Brass/Military - Videos</option>
        <option value="Children_s-releases-basics.parquet">Children's - Basics</option>
        <option value="Children_s-releases-tracks.parquet">Children's - Tracks</option>
        <option value="Children_s-releases-videos.parquet">Children's - Videos</option>
        <option value="Classical-releases-basics.parquet">Classical - Basics</option>
        <option value="Classical-releases-tracks.parquet">Classical - Tracks</option>
        <option value="Classical-releases-videos.parquet">Classical - Videos</option>
        <option value="Electronic-releases-basics.parquet">Electronic - Basics</option>
        <option value="Electronic-releases-tracks.parquet">Electronic - Tracks</option>
        <option value="Electronic-releases-videos.parquet">Electronic - Videos</option>
        <option value="Folk_World_Country-releases-basics.parquet">Folk/World/Country - Basics</option>
        <option value="Folk_World_Country-releases-tracks.parquet">Folk/World/Country - Tracks</option>
        <option value="Folk_World_Country-releases-videos.parquet">Folk/World/Country - Videos</option>
        <option value="Funk_Soul-releases-basics.parquet">Funk/Soul - Basics</option>
        <option value="Funk_Soul-releases-tracks.parquet">Funk/Soul - Tracks</option>
        <option value="Funk_Soul-releases-videos.parquet">Funk/Soul - Videos</option>
        <option value="Hip_Hop-releases-basics.parquet">Hip Hop - Basics</option>
        <option value="Hip_Hop-releases-tracks.parquet">Hip Hop - Tracks</option>
        <option value="Hip_Hop-releases-videos.parquet">Hip Hop - Videos</option>
        <option value="Jazz-releases-basics.parquet">Jazz - Basics</option>
        <option value="Jazz-releases-tracks.parquet">Jazz - Tracks</option>
        <option value="Jazz-releases-videos.parquet">Jazz - Videos</option>
        <option value="Latin-releases-basics.parquet">Latin - Basics</option>
        <option value="Latin-releases-tracks.parquet">Latin - Tracks</option>
        <option value="Latin-releases-videos.parquet">Latin - Videos</option>
        <option value="Non_Music-releases-basics.parquet">Non Music - Basics</option>
        <option value="Non_Music-releases-tracks.parquet">Non Music - Tracks</option>
        <option value="Non_Music-releases-videos.parquet">Non Music - Videos</option>
        <option value="Pop-releases-basics.parquet">Pop - Basics</option>
        <option value="Pop-releases-tracks.parquet">Pop - Tracks</option>
        <option value="Pop-releases-videos.parquet">Pop - Videos</option>
        <option value="Reggae-releases-basics.parquet">Reggae - Basics</option>
        <option value="Reggae-releases-tracks.parquet">Reggae - Tracks</option>
        <option value="Reggae-releases-videos.parquet">Reggae - Videos</option>
        <option value="Rock-releases-basics.parquet">Rock - Basics</option>
        <option value="Rock-releases-tracks.parquet">Rock - Tracks</option>
        <option value="Rock-releases-videos.parquet">Rock - Videos</option>
        <option value="Stage_Screen-releases-basics.parquet">Stage/Screen - Basics</option>
        <option value="Stage_Screen-releases-tracks.parquet">Stage/Screen - Tracks</option>
        <option value="Stage_Screen-releases-videos.parquet">Stage/Screen - Videos</option>
    </select>
    <button id="loadBtn">Load</button>
    <br><br>
    
    <label for="filterInput">Filter (current page):</label>
    <input type="text" id="filterInput" placeholder="Type to filter..." disabled>
</div>

<div id="status" class="loading"></div>
<div id="error" class="error"></div>

<div id="tableContainer"></div>

<div class="pagination" id="paginationControls" style="display:none;">
    <button id="prevBtn" disabled>Previous</button>
    <span id="pageInfo">Page 1</span>
    <button id="nextBtn">Next</button>
</div>

<script type="module">
    import { asyncBufferFromUrl, parquetReadObjects, parquetMetadataAsync } from 'https://cdn.jsdelivr.net/npm/hyparquet/src/index.js';
    
    const RELEASE_TAG = '2026-02';
    // Use a CORS proxy if direct GitHub downloads are blocked by browser security. 
    // For direct GitHub Pages usage, usually GitHub releases redirect and can be tricky with CORS.
    // If this fails, consider using a proxy like 'https://cors-anywhere.herokuapp.com/' prefix 
    // OR hosting the parquet files in the gh-pages branch itself.
    const BASE_URL = `https://github.com/jacobmgreer/DiscoDuck/releases/download/${RELEASE_TAG}/`;
    
    let currentFile = null;
    let currentRowStart = 0;
    const PAGE_SIZE = 100;
    let totalRows = 0;
    let allDataOnPage = []; // Store raw data for client-side filtering

    const els = {
        select: document.getElementById('fileSelect'),
        loadBtn: document.getElementById('loadBtn'),
        status: document.getElementById('status'),
        error: document.getElementById('error'),
        container: document.getElementById('tableContainer'),
        filter: document.getElementById('filterInput'),
        pagination: document.getElementById('paginationControls'),
        prevBtn: document.getElementById('prevBtn'),
        nextBtn: document.getElementById('nextBtn'),
        pageInfo: document.getElementById('pageInfo')
    };

    els.loadBtn.addEventListener('click', () => loadParquet(0));
    els.prevBtn.addEventListener('click', () => loadParquet(currentRowStart - PAGE_SIZE));
    els.nextBtn.addEventListener('click', () => loadParquet(currentRowStart + PAGE_SIZE));
    
    els.filterInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allDataOnPage.filter(row => 
            Object.values(row).some(val => String(val).toLowerCase().includes(term))
        );
        renderTable(filtered);
    });

    async function loadParquet(startRow) {
        const filename = els.select.value;
        if (!filename) return;

        els.error.textContent = '';
        els.status.textContent = `Loading ${filename}...`;
        els.container.innerHTML = '';
        els.pagination.style.display = 'none';
        els.filter.disabled = true;

        try {
            const url = BASE_URL + filename;
            
            // 1. Initialize file buffer
            if (!currentFile || els.select.value !== currentFile.name) {
                currentFile = {
                    name: filename,
                    buffer: await asyncBufferFromUrl({ url })
                };
                
                // Read metadata to get total row count
                const metadata = await parquetMetadataAsync(currentFile.buffer);
                totalRows = Number(metadata.num_rows);
            }

            // 2. Validate bounds
            if (startRow < 0) startRow = 0;
            if (startRow >= totalRows) startRow = Math.max(0, totalRows - PAGE_SIZE);
            currentRowStart = startRow;

            // 3. Read Data
            const data = await parquetReadObjects({
                file: currentFile.buffer,
                rowStart: currentRowStart,
                rowEnd: currentRowStart + PAGE_SIZE
            });

            allDataOnPage = data; // Cache for filtering
            
            // 4. Update UI
            els.status.textContent = `Loaded rows ${currentRowStart + 1} to ${Math.min(currentRowStart + PAGE_SIZE, totalRows)} of ${totalRows}`;
            renderTable(data);
            
            // 5. Update Pagination
            els.pagination.style.display = 'flex';
            els.prevBtn.disabled = currentRowStart === 0;
            els.nextBtn.disabled = (currentRowStart + PAGE_SIZE) >= totalRows;
            els.pageInfo.textContent = `Page ${Math.floor(currentRowStart / PAGE_SIZE) + 1}`;
            els.filter.disabled = false;
            els.filter.focus();

        } catch (err) {
            console.error(err);
            els.status.textContent = '';
            els.error.textContent = `Error loading file: ${err.message}. \nNote: If this is a CORS error, GitHub Release assets might be blocking the request.`;
        }
    }

    function renderTable(data) {
        if (!data || data.length === 0) {
            els.container.innerHTML = '<p>No data found.</p>';
            return;
        }

        const keys = Object.keys(data[0]);
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        // Header
        const headerRow = document.createElement('tr');
        keys.forEach(k => {
            const th = document.createElement('th');
            th.textContent = k;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Body
        data.forEach(row => {
            const tr = document.createElement('tr');
            keys.forEach(k => {
                const td = document.createElement('td');
                const val = row[k];
                // Simple formatting for objects/arrays
                td.textContent = (typeof val === 'object' && val !== null) ? JSON.stringify(val) : val;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        els.container.innerHTML = '';
        els.container.appendChild(table);
    }
</script>

</body>
</html>
